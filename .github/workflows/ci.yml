# FPBInject CI/CD Pipeline
#
# This workflow runs comprehensive tests for both lower machine (embedded firmware)
# and upper machine (WebServer) components.

name: FPBInject CI

on:
  push:
    branches: [main, master, develop]
    paths:
      - "Source/**"
      - "App/**"
      - "Tools/**"
      - "cmake/**"
      - "CMakeLists.txt"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, master, develop]
    paths:
      - "Source/**"
      - "App/**"
      - "Tools/**"
      - "cmake/**"
      - "CMakeLists.txt"
      - ".github/workflows/ci.yml"

jobs:
  # ============================================================
  # Lower Machine Tests (Embedded Firmware)
  # ============================================================
  lower-machine:
    name: Lower Machine Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          Tools/install-prerequisites.sh
          sudo apt-get install -y clang-format-14
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-14 100
          pip install cmake-format kconfiglib

      - name: CMake format check
        working-directory: .
        run: |
          echo "üîç Checking CMake file format..."
          chmod +x Tools/cmake_format.sh
          Tools/cmake_format.sh --check
          echo "‚úÖ CMake format check completed!"

      - name: Kconfig lint check
        working-directory: .
        run: |
          echo "üîç Checking Kconfig syntax..."
          python3 Tools/kconfig_lint.py $(find . -name 'Kconfig*')
          echo "‚úÖ Kconfig lint check completed!"

      - name: Check C/C++ code format
        working-directory: .
        run: |
          echo "üîç Checking C/C++ code format..."
          chmod +x Tools/code_format.sh
          Tools/code_format.sh --check

          # Check if there are any formatting differences
          if ! git diff --quiet; then
            echo "‚ùå Code formatting check failed!"
            echo "The following files need formatting:"
            git diff --name-only
            echo ""
            echo "Please run 'Tools/code_format.sh' locally and commit the changes."
            exit 1
          fi
          echo "‚úÖ Code format check passed!"

      - name: Build test (all configurations)
        working-directory: .
        run: |
          echo "üî® Running build tests..."
          chmod +x Tools/build_test.sh
          Tools/build_test.sh
          echo "‚úÖ Build tests passed!"

  # ============================================================
  # Upper Machine Tests (WebServer)
  # ============================================================
  upper-machine:
    name: Upper Machine Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "Tools/requirements.txt"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Tools/requirements.txt
          # Install additional tools for formatting
          pip install black

      - name: Check Python/JS code format
        working-directory: Tools/WebServer
        run: |
          echo "üîç Checking Python/JavaScript code format..."
          chmod +x format.sh
          ./format.sh --check

          # Check if there are any formatting differences
          if ! git diff --quiet; then
            echo "‚ùå Code formatting check failed!"
            echo "The following files need formatting:"
            git diff --name-only
            echo ""
            echo "Please run 'Tools/WebServer/format.sh' locally and commit the changes."
            exit 1
          fi
          echo "‚úÖ Code format check passed!"

      - name: Run backend tests
        working-directory: Tools/WebServer
        run: |
          echo "üß™ Running backend Python tests..."
          python tests/run_tests.py --coverage --target 80
          echo "‚úÖ Backend tests passed!"

      - name: Run frontend tests
        working-directory: Tools/WebServer
        run: |
          echo "üß™ Running frontend JavaScript tests..."
          node tests/test_frontend.js
          echo "‚úÖ Frontend tests passed!"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: Tools/WebServer/tests/htmlcov/
          retention-days: 7

  # ============================================================
  # Summary Job
  # ============================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lower-machine, upper-machine]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "========================================="
          echo "        FPBInject CI Summary"
          echo "========================================="
          echo ""

          if [ "${{ needs.lower-machine.result }}" == "success" ]; then
            echo "‚úÖ Lower Machine Tests: PASSED"
          else
            echo "‚ùå Lower Machine Tests: FAILED"
          fi

          if [ "${{ needs.upper-machine.result }}" == "success" ]; then
            echo "‚úÖ Upper Machine Tests: PASSED"
          else
            echo "‚ùå Upper Machine Tests: FAILED"
          fi

          echo ""

          if [ "${{ needs.lower-machine.result }}" == "success" ] && [ "${{ needs.upper-machine.result }}" == "success" ]; then
            echo "üéâ All CI checks passed!"
            exit 0
          else
            echo "üí• Some CI checks failed!"
            exit 1
          fi
