# FPBInject CI/CD Pipeline
#
# This workflow runs comprehensive tests for both lower machine (embedded firmware)
# and upper machine (WebServer) components.

name: FPBInject CI

on:
  push:
    branches: [main, master, develop]
    paths:
      - "Source/**"
      - "App/**"
      - "Tools/**"
      - "cmake/**"
      - "CMakeLists.txt"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, master, develop]
    paths:
      - "Source/**"
      - "App/**"
      - "Tools/**"
      - "cmake/**"
      - "CMakeLists.txt"
      - ".github/workflows/ci.yml"

jobs:
  # ============================================================
  # Lower Machine Tests (Embedded Firmware)
  # ============================================================
  lower-machine:
    name: Lower Machine Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          Tools/install-prerequisites.sh
          sudo apt-get install -y clang-format-14 shfmt
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-14 100
          pip install cmake-format kconfiglib

      - name: CMake format check
        working-directory: .
        run: |
          echo "üîç Checking CMake file format..."
          chmod +x Tools/cmake_format.sh
          Tools/cmake_format.sh --check
          echo "‚úÖ CMake format check completed!"

      - name: Kconfig lint check
        working-directory: .
        run: |
          echo "üîç Checking Kconfig syntax..."
          python3 Tools/kconfig_lint.py $(find . -name 'Kconfig*')
          echo "‚úÖ Kconfig lint check completed!"

      - name: Check C/C++ code format
        working-directory: .
        run: |
          echo "üîç Checking C/C++ code format..."
          chmod +x Tools/code_format.sh
          Tools/code_format.sh --check

          # Check if there are any formatting differences
          if ! git diff --quiet; then
            echo "‚ùå Code formatting check failed!"
            echo "The following files need formatting:"
            git diff --name-only
            echo ""
            echo "Please run 'Tools/code_format.sh' locally and commit the changes."
            exit 1
          fi
          echo "‚úÖ Code format check passed!"

      - name: Build test (all configurations)
        working-directory: .
        run: |
          echo "üî® Running build tests..."
          chmod +x Tools/build_test.sh
          Tools/build_test.sh
          echo "‚úÖ Build tests passed!"

      - name: Run firmware unit tests with coverage
        working-directory: App/tests
        run: |
          echo "üß™ Running firmware unit tests..."
          sudo apt-get install -y lcov bc
          chmod +x run_tests.sh
          ./run_tests.sh coverage --threshold 80
          echo "‚úÖ Firmware unit tests passed with 80%+ coverage!"

      - name: Upload firmware coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: firmware-coverage-report
          path: App/tests/build/coverage/
          retention-days: 7

  # ============================================================
  # Upper Machine Tests (WebServer)
  # ============================================================
  upper-machine:
    name: Upper Machine Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "Tools/requirements.txt"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Tools/requirements.txt
          # Install additional tools for formatting and linting
          pip install black flake8

      - name: Check Python/JS code format and lint
        working-directory: Tools/WebServer
        run: |
          echo "üîç Checking Python/JavaScript code format and lint..."
          chmod +x format.sh
          ./format.sh --check --lint

          # Check if there are any formatting differences
          if ! git diff --quiet; then
            echo "‚ùå Code formatting check failed!"
            echo "The following files need formatting:"
            git diff --name-only
            echo ""
            echo "Please run 'Tools/WebServer/format.sh' locally and commit the changes."
            exit 1
          fi
          echo "‚úÖ Code format check passed!"

      - name: Run backend tests
        working-directory: Tools/WebServer
        run: |
          echo "üß™ Running backend Python tests..."
          python tests/run_tests.py --coverage --html --target 85
          echo "‚úÖ Backend tests passed!"

      - name: Install Node.js dependencies
        working-directory: Tools/WebServer
        run: |
          echo "üì¶ Installing Node.js dependencies..."
          npm install
          echo "‚úÖ Node.js dependencies installed!"

      - name: Run frontend tests
        working-directory: Tools/WebServer
        run: |
          echo "üß™ Running frontend JavaScript tests with coverage..."
          node tests/test_frontend.js --coverage --ci --threshold 80
          echo "‚úÖ Frontend tests passed!"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            Tools/WebServer/tests/htmlcov/
            Tools/WebServer/tests/coverage/
          retention-days: 7

  # ============================================================
  # Summary Job
  # ============================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lower-machine, upper-machine]
    if: always()
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download firmware coverage report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: firmware-coverage-report
          path: firmware-coverage

      - name: Download WebServer coverage report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report
          path: webserver-coverage

      - name: Generate coverage summary
        id: coverage
        run: |
          echo "========================================="
          echo "     Generating Coverage Summary"
          echo "========================================="

          # Install lcov for parsing
          sudo apt-get update && sudo apt-get install -y lcov

          FIRMWARE_COV="N/A"
          BACKEND_COV="N/A"
          FRONTEND_COV="N/A"

          # Debug: Show what files were downloaded
          echo "--- Downloaded files ---"
          find firmware-coverage webserver-coverage -type f 2>/dev/null || echo "No coverage files found"
          echo "------------------------"

          # Parse firmware coverage from lcov
          FIRMWARE_LCOV=$(find firmware-coverage -name "coverage.info" -type f 2>/dev/null | head -1)
          if [ -n "$FIRMWARE_LCOV" ]; then
            echo "Found $FIRMWARE_LCOV"
            FIRMWARE_COV=$(lcov --summary "$FIRMWARE_LCOV" 2>&1 | grep -E "lines\.*:" | sed -E 's/.*: ([0-9.]+)%.*/\1%/' || echo "N/A")
          fi

          # Parse backend Python coverage from htmlcov - search for it dynamically
          BACKEND_HTML=$(find webserver-coverage -path "*/htmlcov/index.html" -type f 2>/dev/null | head -1)
          if [ -n "$BACKEND_HTML" ]; then
            echo "Found $BACKEND_HTML"
            # Python coverage.py html format: class="pc_cov">XX%</td>
            BACKEND_COV=$(grep -oE 'pc_cov">[0-9]+%' "$BACKEND_HTML" | head -1 | sed 's/pc_cov">//' || echo "N/A")
          fi

          # Parse frontend JavaScript coverage from lcov.info - search dynamically
          FRONTEND_LCOV=$(find webserver-coverage -name "lcov.info" -type f 2>/dev/null | head -1)
          if [ -n "$FRONTEND_LCOV" ]; then
            echo "Found $FRONTEND_LCOV"
            FRONTEND_COV=$(lcov --summary "$FRONTEND_LCOV" 2>&1 | grep -E "lines\.*:" | sed -E 's/.*: ([0-9.]+)%.*/\1%/' || echo "N/A")
          fi

          # Fallback: if firmware still N/A, try html/index.html
          if [ "$FIRMWARE_COV" = "N/A" ]; then
            FIRMWARE_HTML=$(find firmware-coverage -name "index.html" -type f 2>/dev/null | head -1)
            if [ -n "$FIRMWARE_HTML" ]; then
              FIRMWARE_COV=$(grep -oE '[0-9]+\.?[0-9]*%' "$FIRMWARE_HTML" | head -1 || echo "N/A")
            fi
          fi

          echo "firmware_cov=$FIRMWARE_COV" >> $GITHUB_OUTPUT
          echo "backend_cov=$BACKEND_COV" >> $GITHUB_OUTPUT
          echo "frontend_cov=$FRONTEND_COV" >> $GITHUB_OUTPUT

          echo ""
          echo "========================================="
          echo "Firmware Coverage: $FIRMWARE_COV"
          echo "Backend Coverage:  $BACKEND_COV"
          echo "Frontend Coverage: $FRONTEND_COV"
          echo "========================================="

      - name: Post coverage to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const firmwareCov = '${{ steps.coverage.outputs.firmware_cov }}';
            const backendCov = '${{ steps.coverage.outputs.backend_cov }}';
            const frontendCov = '${{ steps.coverage.outputs.frontend_cov }}';
            
            const lowerResult = '${{ needs.lower-machine.result }}';
            const upperResult = '${{ needs.upper-machine.result }}';
            
            const getStatusEmoji = (result) => result === 'success' ? '‚úÖ' : '‚ùå';
            const getCovEmoji = (cov) => {
              if (cov === 'N/A') return '‚ö™';
              const num = parseFloat(cov);
              if (num >= 80) return 'üü¢';
              if (num >= 60) return 'üü°';
              return 'üî¥';
            };
            
            const body = `## üìä FPBInject CI Coverage Report
            
            | Component | Status | Coverage |
            |-----------|--------|----------|
            | Firmware (Lower Machine) | ${getStatusEmoji(lowerResult)} ${lowerResult} | ${getCovEmoji(firmwareCov)} ${firmwareCov} |
            | Backend (Python) | ${getStatusEmoji(upperResult)} ${upperResult} | ${getCovEmoji(backendCov)} ${backendCov} |
            | Frontend (JavaScript) | ${getStatusEmoji(upperResult)} ${upperResult} | ${getCovEmoji(frontendCov)} ${frontendCov} |
            
            ---
            <details>
            <summary>üìÅ Coverage Artifacts</summary>
            
            - üì¶ **firmware-coverage-report**: Firmware unit test coverage (lcov)
            - üì¶ **coverage-report**: WebServer backend & frontend coverage
            
            Download from the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) tab.
            </details>
            
            > üéØ Coverage threshold: **80%**
            > üìÖ Generated at: ${new Date().toISOString()}
            `;
            
            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('FPBInject CI Coverage Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing coverage comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new coverage comment');
            }

      - name: Check job results
        run: |
          echo "========================================="
          echo "        FPBInject CI Summary"
          echo "========================================="
          echo ""

          if [ "${{ needs.lower-machine.result }}" == "success" ]; then
            echo "‚úÖ Lower Machine Tests: PASSED"
          else
            echo "‚ùå Lower Machine Tests: FAILED"
          fi

          if [ "${{ needs.upper-machine.result }}" == "success" ]; then
            echo "‚úÖ Upper Machine Tests: PASSED"
          else
            echo "‚ùå Upper Machine Tests: FAILED"
          fi

          echo ""

          if [ "${{ needs.lower-machine.result }}" == "success" ] && [ "${{ needs.upper-machine.result }}" == "success" ]; then
            echo "üéâ All CI checks passed!"
            exit 0
          else
            echo "üí• Some CI checks failed!"
            exit 1
          fi
