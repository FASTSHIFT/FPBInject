<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FPBInject Workbench</title>
  <!-- VS Code Design System -->
  <link rel="stylesheet" href="/static/css/workbench.css" />
  <!-- Codicons (using CDN for icons) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vscode/codicons@0.0.32/dist/codicon.min.css" />
  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
</head>

<body>
  <!-- TITLE BAR -->
  <div class="title-bar">
    <div class="title-bar-left">
      <i class="codicon codicon-beaker" style="margin-right: 8px; color: #007acc;"></i>
      <a href="https://github.com/FASTSHIFT/FPBInject" target="_blank" class="app-title"
        style="color: inherit; text-decoration: none;">FPBInject Workbench</a>
    </div>
    <div class="title-bar-center">
      <span class="workspace-title" id="clockDisplay"></span>
    </div>
    <div class="title-bar-right">
      <div class="author-link">
        <i class="codicon codicon-github-action"></i>
        <a href="https://github.com/FASTSHIFT" target="_blank" style="color: inherit; text-decoration: none;">VIFEX</a>
      </div>
      <div class="window-controls">
        <div class="window-control minimize"><i class="codicon codicon-chrome-minimize"></i></div>
        <div class="window-control maximize"><i class="codicon codicon-chrome-restore"></i></div>
        <div class="window-control close"><i class="codicon codicon-chrome-close"></i></div>
      </div>
    </div>
  </div>

  <!-- ACTIVITY BAR -->
  <div class="activity-bar">
    <div class="activity-item active" title="Explorer">
      <i class="codicon codicon-files"></i>
    </div>
    <div class="activity-item" title="Search">
      <i class="codicon codicon-search"></i>
    </div>
    <div class="activity-item" title="Source Control">
      <i class="codicon codicon-source-control"></i>
    </div>
    <div class="activity-item" title="Debug">
      <i class="codicon codicon-debug-alt"></i>
    </div>
    <div class="spacer"></div>
    <div class="activity-item" title="Settings">
      <i class="codicon codicon-settings-gear"></i>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-title">
      <span>EXPLORER</span>
      <i class="codicon codicon-ellipsis"></i>
    </div>

    <!-- Connection Section -->
    <div class="sidebar-section">
      <details open>
        <summary class="sidebar-header">
          <i class="codicon codicon-chevron-right"></i>
          <span>CONNECTION</span>
        </summary>
        <div class="sidebar-content">
          <div class="flex-col">
            <div class="flex-row">
              <select id="portSelect" class="vscode-select" title="Serial Port"></select>
              <button class="vscode-btn icon-only secondary" onclick="refreshPorts()" title="Refresh Ports">
                <i class="codicon codicon-refresh"></i>
              </button>
            </div>
            <div class="flex-row">
              <input type="number" id="baudrate" class="vscode-input" value="115200" placeholder="Baudrate" />
              <button id="connectBtn" class="vscode-btn" onclick="toggleConnect()" style="flex: 1">Connect</button>
            </div>
          </div>
        </div>
      </details>
    </div>

    <!-- Device Info -->
    <div class="sidebar-section">
      <details open>
        <summary class="sidebar-header">
          <i class="codicon codicon-chevron-right"></i>
          <span>DEVICE INFO</span>
        </summary>
        <div class="sidebar-content">
          <div class="flex-row" style="font-size: 11px; justify-content: space-between;">
            <span>Function:</span>
            <span id="targetFuncDisplay" style="color: var(--vscode-descriptionForeground)">-</span>
          </div>
          <div class="flex-row" style="font-size: 11px; justify-content: space-between;">
            <span>Injected:</span>
            <span id="injectFuncDisplay" style="color: var(--vscode-descriptionForeground)">-</span>
          </div>
          <div class="flex-row" style="margin-top: 8px;">
            <button onclick="fpbPing()" class="vscode-btn secondary" style="flex:1; font-size: 10px;">Ping</button>
            <button onclick="fpbInfo()" class="vscode-btn secondary" style="flex:1; font-size: 10px;">Info</button>
            <button onclick="fpbUnpatch()" class="vscode-btn secondary"
              style="flex:1; font-size: 10px;">Unpatch</button>
          </div>
        </div>
      </details>
    </div>

    <!-- Configuration -->
    <div class="sidebar-section">
      <details>
        <summary class="sidebar-header">
          <i class="codicon codicon-chevron-right"></i>
          <span>CONFIGURATION</span>
        </summary>
        <div class="sidebar-content">
          <div class="flex-col">
            <div class="flex-row">
              <input type="text" id="elfPath" class="vscode-input" placeholder="ELF Path" />
              <button class="vscode-btn icon-only secondary" onclick="browseFile('elfPath', '.elf')">
                <i class="codicon codicon-folder-opened"></i>
              </button>
            </div>
            <div class="flex-row">
              <input type="text" id="compileCommandsPath" class="vscode-input" placeholder="compile_commands.json" />
              <button class="vscode-btn icon-only secondary" onclick="browseFile('compileCommandsPath', '.json')">
                <i class="codicon codicon-folder-opened"></i>
              </button>
            </div>
            <div class="flex-row">
              <input type="text" id="toolchainPath" class="vscode-input" placeholder="Toolchain Bin Path" />
              <button class="vscode-btn icon-only secondary" onclick="browseDir('toolchainPath')">
                <i class="codicon codicon-folder-opened"></i>
              </button>
            </div>
            <div class="flex-row">
              <select id="patchMode" class="vscode-select">
                <option value="trampoline">Trampoline</option>
                <option value="debugmon">DebugMonitor</option>
                <option value="direct">Direct</option>
              </select>
            </div>
            <div class="flex-row">
              <input type="checkbox" id="watcherEnable" onchange="toggleWatcher()" />
              <label for="watcherEnable" style="font-size: 11px;">Enable File Watcher</label>
            </div>
            <textarea id="watchDirs" class="vscode-input" rows="3" placeholder="Watch Dirs"
              style="height: auto;"></textarea>
            <button onclick="saveConfig()" class="vscode-btn secondary" style="width: 100%">Save Config</button>
          </div>
        </div>
      </details>
    </div>

    <!-- Symbols -->
    <div class="sidebar-section">
      <details open>
        <summary class="sidebar-header">
          <i class="codicon codicon-chevron-right"></i>
          <span>SYMBOLS</span>
        </summary>
        <div class="sidebar-content" style="padding: 0;">
          <div style="padding: 4px 8px; border-bottom: 1px solid var(--vscode-panel-border);">
            <input type="text" id="symbolSearch" class="vscode-input" placeholder="Search Symbols..."
              oninput="searchSymbols()" style="height: 22px; font-size: 11px;" />
          </div>
          <div id="symbolList">
            <!-- Populated by JS -->
            <div style="padding: 8px; font-size: 11px; opacity: 0.7;">No symbols loaded</div>
          </div>
        </div>
      </details>
    </div>
  </div>

  <!-- MAIN EDITOR AREA -->
  <div class="editor-container">
    <div class="editor-tabs-header">
      <div class="tab active">
        <i class="codicon codicon-file-code tab-icon" style="color: #e37933;"></i>
        <span>patch_source.c</span>
        <div class="tab-close"><i class="codicon codicon-close"></i></div>
      </div>
    </div>

    <div class="editor-toolbar">
      <div class="flex-col" style="gap: 2px;">
        <label style="font-size: 10px; opacity: 0.7;">TARGET FUNCTION</label>
        <input type="text" id="targetFunc" class="vscode-input" style="width: 200px;" placeholder="main" />
      </div>

      <div class="spacer"></div>

      <button class="vscode-btn secondary" onclick="generatePatch()">
        <i class="codicon codicon-file-add" style="margin-right: 4px;"></i> Generate Template
      </button>
      <button class="vscode-btn secondary" onclick="autoGeneratePatch()">
        <i class="codicon codicon-wand" style="margin-right: 4px;"></i> Auto Gen
      </button>

      <div style="width: 1px; height: 16px; background: var(--vscode-panel-border); margin: 0 4px;"></div>

      <button id="injectBtn" onclick="performInject()" class="vscode-btn">
        <i class="codicon codicon-play" style="margin-right: 4px;"></i> Inject
      </button>
    </div>

    <div class="editor-main">
      <!-- Using simple textarea for now, but styled like an editor -->
      <!-- Hidden inputs for logic compatibility -->
      <input type="hidden" id="autoPatchSource" /> <!-- Compatibility for auto patch logic -->

      <textarea id="patchSource" class="code-editor" spellcheck="false" style="
                width: 100%; height: 100%; border: none; resize: none; outline: none;
                background: var(--vscode-editor-background);
                color: var(--vscode-foreground);
                padding: 10px;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 14px;
             "></textarea>

      <!-- Overlay progress indicator -->
      <div id="injectProgress"
        style="display: none; position: absolute; bottom: 10px; right: 10px; background: var(--vscode-activityBar-background); padding: 5px 10px; border-radius: 3px; border: 1px solid var(--vscode-panel-border); font-size: 11px;">
        <span id="injectProgressText">Injecting...</span>
        <div id="injectProgressFill"
          style="height: 2px; background: var(--success-color); width: 0%; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>

  <!-- TERMINAL PANEL -->
  <div class="panel-container">
    <div class="panel-header">
      <div class="panel-tab active" onclick="switchTerminalTab('tool')" id="tabBtnTool">OUTPUT</div>
      <div class="panel-tab" onclick="switchTerminalTab('raw')" id="tabBtnRaw">SERIAL PORT</div>
      <div class="panel-actions">
        <button class="vscode-btn icon-only secondary" onclick="clearCurrentTerminal()" title="Clear">
          <i class="codicon codicon-clear-all"></i>
        </button>
        <div class="flex-row">
          <input type="checkbox" id="autoCompile" onchange="onAutoCompileChange()" />
          <label for="autoCompile" style="font-size: 11px;">Auto Inject on Save</label>
        </div>
      </div>
    </div>
    <div class="panel-content">
      <!-- Tool Terminal -->
      <div id="terminalPanelTool" style="width: 100%; height: 100%;">
        <div id="terminal-container" style="width: 100%; height: 100%;"></div>
      </div>
      <!-- Raw Terminal -->
      <div id="terminalPanelRaw" style="width: 100%; height: 100%; display: none;">
        <div id="raw-terminal-container" style="width: 100%; height: 100%;"></div>
      </div>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="status-bar">
    <div class="status-left">
      <div class="status-item">
        <i class="codicon codicon-plug"></i>
        <span id="connectionIndicatorBase"></span>
        <span id="connectionStatus">Disconnected</span>
      </div>
      <div class="status-item">
        <i class="codicon codicon-eye"></i>
        <span id="watcherStatus">Watcher: Off</span>
      </div>
    </div>
    <div class="status-right">
      <div class="status-item">UTF-8</div>
      <div class="status-item">C</div>
      <div class="status-item"><i class="codicon codicon-bell"></i></div>
    </div>
  </div>

  <!-- File Browser Modal (retained but styled) -->
  <div class="modal-overlay" id="fileBrowserModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center;">
    <div class="modal"
      style="background: var(--vscode-sideBar-background); padding: 20px; border: 1px solid var(--vscode-panel-border); width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <div class="modal-header" style="margin-bottom: 10px; display: flex; justify-content: space-between;">
        <h3 style="margin: 0;">File Browser</h3>
        <button class="vscode-btn icon-only secondary" onclick="closeFileBrowser()"><i
            class="codicon codicon-close"></i></button>
      </div>
      <div class="modal-body">
        <div class="flex-row" style="margin-bottom: 10px;">
          <input type="text" id="browserPath" class="vscode-input" onkeyup="onBrowserPathKeyup(event)" />
          <button class="vscode-btn secondary"
            onclick="navigateTo(document.getElementById('browserPath').value)">Go</button>
        </div>
        <div class="file-list" id="fileList"
          style="height: 300px; overflow-y: auto; border: 1px solid var(--vscode-input-border); background: var(--vscode-input-background);">
          <!-- File list -->
        </div>
      </div>
      <div class="modal-footer" style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
        <button class="vscode-btn secondary" onclick="closeFileBrowser()">Cancel</button>
        <button class="vscode-btn" onclick="selectBrowserItem()">Select</button>
      </div>
    </div>
  </div>

  <!-- Legacy JS -->
  <script src="/static/js/app.js"></script>
  <script>
    // Additional UI logic for new Workbench
    function updateClock() {
      const now = new Date();
      // Format: YYYY-MM-DD HH:mm:ss
      const timeString = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0') + ' ' +
        String(now.getHours()).padStart(2, '0') + ':' +
        String(now.getMinutes()).padStart(2, '0');
      const clock = document.getElementById('clockDisplay');
      if (clock) clock.innerText = timeString;
    }

    document.addEventListener('DOMContentLoaded', () => {
      setInterval(updateClock, 1000);
      updateClock();

      // Hack to make sure terminal resizes
      window.addEventListener('resize', () => {
        // If using xterm-addon-fit, trigger it
      });

      // Adjust terminal size on load
      setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
      }, 500);
    });
  </script>
</body>

</html>